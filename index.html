<!DOCTYPE html>
<html>
<Title>Funny talk</Title>
Apply sound effects to your talk! 
<br><br>
Warning for audio feedback, use headphones to prevent it.<br>
<input id="startStopButton" type="button" value="Start" />
<script>
(function() {
	var AudioContext = window.AudioContext || window.webkitAudioContext;
	var audioContext;
	var mediaStreamSource;
	var reverb;
	var delay;
	var reverbIrBuffer;
	
	navigator.getUserMedia = (navigator.getUserMedia ||
        navigator.webkitGetUserMedia ||
        navigator.mozGetUserMedia ||
        navigator.msGetUserMedia);
	
    if (navigator.getUserMedia) {
        audioContext = new AudioContext();
        document.querySelector("#startStopButton").addEventListener('click', startStopButton_Clicked);
        
        function loadAudio(url) {
            var request = new XMLHttpRequest();
            request.open('GET', url, true);
            request.responseType = 'arraybuffer';
            
            request.onload = function() {
                audioContext.decodeAudioData(request.response, function(buffer) {
                    reverbIrBuffer = buffer;
					console.log('Sound file downloaded');
                });
            }
            request.send();
        }
        
		loadAudio('DonKarlssonSanImpulseResponse.ogg');        
        
		function gotStream(stream) {
			if(audioContext === null) {	
				audioContext = new AudioContext();
			}
            mediaStreamSource = audioContext.createMediaStreamSource(stream);
            reverb = audioContext.createConvolver();
			reverb.buffer = reverbIrBuffer;

            
            /*
            var biquadFilter = audioContext.createBiquadFilter();
            biquadFilter.type = "bandpass";
            //biquadFilter.frequency.value = 500;
            //biquadFilter.Q.value = 100;
            //biquadFilter.gain.value = 25;
            
            var now = audioContext.currentTime;
            biquadFilter.frequency.setValueAtTime( 0, now );
            biquadFilter.frequency.linearRampToValueAtTime( 2000.0, now + 3.0 );
            biquadFilter.frequency.linearRampToValueAtTime( 0.0, now + 6.0 );
            biquadFilter.frequency.linearRampToValueAtTime( 2000.0, now + 9.0 );
            biquadFilter.frequency.linearRampToValueAtTime( 0.0, now + 12.0 );
            
            biquadFilter.Q.setValueAtTime( 20.0, now );
            biquadFilter.Q.linearRampToValueAtTime( 10.0, now + 6 );
            biquadFilter.Q.setValueAtTime( 20.0, now + 9 );
            biquadFilter.Q.linearRampToValueAtTime( 10.0, now + 12 );
            */
            
            delay = audioContext.createDelay();
            delay.delayTime.value = 3;
            
            //mediaStreamSource.connect(biquadFilter);
            //biquadFilter.connect(delay);
            mediaStreamSource.connect(reverb);
            reverb.connect(delay);
            delay.connect(audioContext.destination);
			
			document.querySelector("#startStopButton").value = "Stop";
			document.querySelector("#startStopButton").disabled = false;			
        }
        
        function startStopButton_Clicked() {
			console.log(this.value);
			if(this.value === "Start") {
				this.disabled = true;
				navigator.getUserMedia( {audio:true}, gotStream, error);
			} else {
				stopSound();
			}
		}
				
		function stopSound() {
			console.log("Stopping sound");

			mediaStreamSource.disconnect();
			mediaStreamSource = null;
			reverb.disconnect();
			reverb = null;
			delay.disconnect();
			delay = null;
			audioContext = null;
			
			document.querySelector("#startStopButton").value = "Start";		
		}
		
        function error(message)
        {
            console.log(message);
        }

    } else {
        document.querySelector("#startStopButton").disabled = true;
        alert("Sorry, you can't use the mic in this web browser. Try latest version of Firefox, Chrome or Safari.");
    }
  })();
</script>
</html>
